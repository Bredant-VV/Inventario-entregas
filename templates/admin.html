<!DOCTYPE html>
<html>
<head>
    <title>Administrador</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>Administrador</h1>
<a href="/logout">Cerrar sesi√≥n</a>

<br><br>

<!-- üîé BUSCADOR POR POO O FACTURA -->
<div style="margin:20px 0;">
    <input 
        type="text" 
        id="buscarDoc" 
        placeholder="Buscar por POO o Factura..."
        style="padding:8px; width:250px;"
    >
    <button onclick="buscarDocumento()" style="padding:8px;">
        Buscar
    </button>
    <button onclick="cargar()" style="padding:8px;">
        Mostrar activos
    </button>
</div>

<hr>

<!-- FORMULARIO -->
<input id="id" placeholder="ID">
<select id="accesorio"></select>
<select id="modelo"></select>
<input id="nombre" placeholder="Nombre">
<input id="poo" placeholder="POO">
<input id="factura" placeholder="Factura">
<button type="button" onclick="agregar()">Agregar</button>

<br><br>

<input id="nuevoAcc" placeholder="Nuevo accesorio">
<button type="button" onclick="agregarAcc()">Agregar accesorio</button>

<input id="nuevoMod" placeholder="Nuevo modelo">
<button type="button" onclick="agregarMod()">Agregar modelo</button>

<hr>

<div id="cards" class="cards"></div>

<script>

// ================= CARGAR CATALOGO =================

async function cargarCatalogo(){
    const res = await fetch("/api/catalogo");
    const data = await res.json();

    const accesorios = data.filter(item => item.tipo === "accesorio");
    const modelos = data.filter(item => item.tipo === "modelo");

    document.getElementById("accesorio").innerHTML =
        accesorios.map(a => `<option>${a.valor}</option>`).join("");

    document.getElementById("modelo").innerHTML =
        modelos.map(m => `<option>${m.valor}</option>`).join("");
}

// ================= CARGAR REGISTROS =================

async function cargar(){
    const res = await fetch("/api/registros");
    const data = await res.json();
    pintar(data);
}

function pintar(data){
    document.getElementById("cards").innerHTML = data.map(r=>`
        <div class="card small">
            <b>${r.id}</b>
            <div>${r.accesorio}</div>
            <div>${r.modelo}</div>
            <div>${r.nombre}</div>
            <div><small>${r.estado}</small></div>
            <button onclick="entregar('${r.id}')">Entregado</button>
            <button onclick="eliminarR('${r.id}')">Eliminar</button>
        </div>
    `).join("");
}

// ================= AGREGAR REGISTRO =================

async function agregar(){
    await fetch("/api/agregar",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            id:id.value,
            accesorio:accesorio.value,
            modelo:modelo.value,
            nombre:nombre.value,
            poo:poo.value,
            factura:factura.value
        })
    });

    id.value="";
    nombre.value="";
    poo.value="";
    factura.value="";

    cargar();
}

// ================= ENTREGAR / ELIMINAR =================

async function entregar(id){
    await fetch("/api/entregado/"+id,{method:"PUT"});
    cargar();
}

async function eliminarR(id){
    await fetch("/api/eliminar/"+id,{method:"DELETE"});
    cargar();
}

// ================= AGREGAR CATALOGO =================

async function agregarAcc(){
    await fetch("/api/catalogo",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({tipo:"accesorio",valor:nuevoAcc.value})
    });
    nuevoAcc.value="";
    cargarCatalogo();
}

async function agregarMod(){
    await fetch("/api/catalogo",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({tipo:"modelo",valor:nuevoMod.value})
    });
    nuevoMod.value="";
    cargarCatalogo();
}

// ================= BUSCAR POR POO / FACTURA =================

async function buscarDocumento(){
    const valor = document.getElementById("buscarDoc").value.trim();

    if(!valor){
        cargar();
        return;
    }

    const res = await fetch("/api/buscar/"+valor);
    const data = await res.json();

    pintar(data);
}

// Enter para buscar
document.getElementById("buscarDoc").addEventListener("keypress", function(e){
    if(e.key === "Enter"){
        buscarDocumento();
    }
});

// ================= INIT =================

cargarCatalogo();
cargar();

</script>

</body>
</html>